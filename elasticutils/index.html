<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.16.8"><link rel="alternate" type="application/rss+xml" title="Kevin Stone" href="/rss.xml"><title>ElasticSearch Bliss with ElasticUtils</title><link rel="canonical" href="https://blog.kevinastone.com/elasticutils/"><meta name="description" content="Personal blog for Kevin Stone."><meta name="robots" content="index, follow"><meta property="og:title" content="ElasticSearch Bliss with ElasticUtils"><meta property="og:type" content="article"><meta property="og:image" content><meta property="og:url" content="https://blog.kevinastone.com/elasticutils/"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@kevinastone"><meta name="keywords"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/assets/ClientRouter.astro_astro_type_script_index_0_lang.CDGfc0hd.js"></script><style>code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment,.token.prolog,.token.doctype,.token.cdata{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.property,.token.tag,.token.constant,.token.symbol,.token.deleted{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.selector,.token.attr-name,.token.string,.token.char,.token.builtin,.token.inserted{color:#a6e22e}.token.operator,.token.entity,.token.url,.language-css .token.string,.style .token.string,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.function,.token.class-name{color:#e6db74}.token.keyword{color:#66d9ef}.token.regex,.token.important{color:#fd971f}.token.important,.token.bold{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.img-wrapper[data-astro-cid-3eui6wlw]{background-color:var(--base);display:flex;position:absolute;overflow:hidden;width:100%;height:100%}.img-wrapper[data-astro-cid-3eui6wlw] .duotone-img{filter:grayscale(100%) contrast(1);mix-blend-mode:multiply;opacity:var(--opacity);object-fit:cover;width:100%;height:100%;display:block}.img-wrapper[data-astro-cid-3eui6wlw]:before{content:"";position:absolute;inset:0;background-color:var(--foreground);mix-blend-mode:overlay;z-index:1;pointer-events:none}/*! tailwindcss v4.1.18 | MIT License | https://tailwindcss.com */@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-font-weight:initial}}}.wrapper[data-astro-cid-vva3ln22]{justify-content:center;align-items:center;width:100%;display:flex;position:relative}.hero[data-astro-cid-vva3ln22]{color:#fff;margin-bottom:var(--spacing-rhythm-1\.5,calc(1.5*var(--spacing-rhythm)));padding-block:var(--spacing-rhythm-2,calc(2*var(--spacing-rhythm)));text-align:center}.hero[data-astro-cid-vva3ln22] h1{margin-top:var(--spacing-rhythm-2,calc(2*var(--spacing-rhythm)));margin-bottom:calc(var(--spacing,.25rem)*8);font-size:var(--text-4xl,2.25rem);line-height:var(--tw-leading,var(--text-4xl--line-height,calc(2.5/2.25)));--tw-font-weight:var(--font-weight-bold,700);font-weight:var(--font-weight-bold,700)}.bg[data-astro-cid-vva3ln22]{z-index:1;object-fit:cover;object-position:center;width:100%;height:100%;position:absolute;inset:0}.content[data-astro-cid-vva3ln22]{z-index:3;position:relative}@property --tw-font-weight{syntax:"*";inherits:false}
</style>
<link rel="stylesheet" href="/assets/_id_.B_Iir7RE.css"></head> <body> <header class="brand-bg-gradient" data-astro-cid-3ef6ksr2> <div class="navbar" data-astro-cid-3ef6ksr2> <div class="fixed-width">  <div class="row" data-astro-cid-3ef6ksr2> <div class="brand" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2>Kevin Stone</a> </div> <div class="search" data-astro-cid-3ef6ksr2> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><script>(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="Z2vjQsh" prefix="r2" component-url="/assets/app.CymAaFJ5.js" component-export="default" renderer-url="/assets/client.C7vZbhPY.js" props="{&quot;data-astro-cid-3ef6ksr2&quot;:[0,true]}" ssr client="load" opts="{&quot;name&quot;:&quot;Search&quot;,&quot;value&quot;:true}" await-children><form class="relative w-full m-0"><input class="
        w-full
        bg-transparent
        border
        border-accent
        rounded-sm
        text-background
        m-0
        outline-none
        py-1
        px-3
        transition-colors
        duration-500
        focus:bg-background
        focus:border-transparent
        focus:text-primary
        hover:bg-background
        hover:border-transparent
        hover:text-primary
        not-placeholder-shown:bg-background
        not-placeholder-shown:text-primary
      " type="search" name="query" placeholder="Search" autoComplete="off" autoCorrect="off" autoCapitalize="off" spellcheck="false" value=""/><ul class="absolute w-full mt-1 overflow-hidden list-none p-0 bg-background rounded-md shadow-lg z-50"></ul></form><!--astro:end--></astro-island> </div> </div>  </div> </div> </header>  <div class="wrapper hero brand-bg-gradient" data-astro-cid-vva3ln22>  <div class="content" data-astro-cid-vva3ln22>  <div class="fixed-width">  <h1>ElasticSearch Bliss with ElasticUtils</h1> <p class="sub-heading"> <time datetime="2013-12-30T00:00:00.000Z"> December 30, 2013 </time> </p>  </div>  </div> </div>  <main> <div class="fixed-width">    <article class="prose max-w-none"> <p>While <a href="http://haystacksearch.org">Django Haystack</a> remains the go to recommendation for adding simple search indexing to your Django sites, you can quickly outgrow the simplified “bag of text” data model that haystack attempts to unify the various supported indexing engines. Depending on your use case, you eventually need to customize the tokenizers, scoring, spell correct, autocomplete, etc. These more advanced use cases no longer work commonly across backends forcing you to leave the comfort of Haystack for native APIs for your chosen indexer. <a href="https://github.com/mozilla/elasticutils">ElasticUtils</a> is a newer project from the fine folks at <a href="http://www.mozilla.org/">Mozilla</a> that exposes much of the rich capabilities of <a href="http://www.elasticsearch.org">ElasticSearch</a> in a more elegant, pythonic interface. Much like an <a href="http://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a> can simplify the process of generating SQL for your databsae queries, ElasticUtils provides a streamlined interface for generating search queries for the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl.html">ElasticSearch Query DSL</a>.</p>
<h2 id="why-elasticsearch">Why ElasticSearch</h2>
<p>Why <a href="http://www.elasticsearch.org">ElasticSearch</a> could really be its own blog post. It’s an immensely powerful search indexing system built on top of the rock solid <a href="http://lucene.apache.org">Lucene</a> library. It features a considerable number of built in query and filter types that allow great range in the type of search conditions allowed. In addition, it has many customizable tokenizers, analyzers and filters to transform your documents into readily identified search results. It’s most frequently compared to <a href="http://lucene.apache.org/solr/">SOLR</a> (which is also Lucene based), which provides similar features. Comparatively, the ReST based API interface of ElasticSearch shifts much of the data definition and configuration to the client, eliminating the burdensome and more rigid system administration challenges of SOLR. Finally, ElasticSearch (as the name gives away), was built with clustering in mind from the start, providing a pathway to sharding your dataset relatively seamlessly for scalability as your system grows.</p>
<p>Having said that, ElasticSearch is a powerful, but intricate search system. Don’t expect to be able to bolt it on to a project for a simple full-text search, there’s likely easier solutions on the market. There’s a lot of knobs and parameters, and you’re going to need to make an investment to fully understand the ElasticSearch architecture. ElasticUtils doesn’t really attempt to abstract away those details in the way that <a href="http://haystacksearch.org">Django Haystack</a> may. It does have rather sensible defaults though, that make getting started more of a weekend project than a month long sabbatical.</p>
<p>Ironically, ElasticSearch’s flexibility has opened it up to non-traditional indexing use cases such as <a href="http://logstash.net">log management</a>, analytics and data mining.</p>
<h2 id="elasticutils-in-action">ElasticUtils in Action</h2>
<p><a href="http://www.elasticsearch.org">ElasticSearch</a> allows creating rich, complex search queries using a <a href="http://en.wikipedia.org/wiki/Representational_state_transfer" title="Representational State Transfer">ReSTful API</a>. Beyond the basic, find documents that match the given terms, you can filter your searches by categories or other criteria (usually called faceting, such as those tag clouds or drill-downs). It features considerable function to develop powerful and specialized search applications.</p>
<p>The challenge with many rich, expressive query languages, is how to generate these expressions reliability without a significant maintenance cost to the development team. Enter <a href="https://github.com/mozilla/elasticutils">ElasticUtils</a>, which provides access to most of ElasticSearch’s features, but using a chainable queryset-like expression API for generating search parameters.</p>
<p>As a case, here’s an actual (relatively simply) query generated from our search system looking for products related to “nike air max” (a line of shoes):</p>
<pre class="language-json" data-language="json"><code is:raw="" class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"is_visible"</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"query_string"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"default_field"</span><span class="token operator">:</span> <span class="token string">"_all"</span><span class="token punctuation">,</span>
            <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"nike air max"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This query, takes our user supplied input: “nike air max”, and generates a <code>query_string</code> type query against the <code>_all</code> field (which is a combination of all the indexed fields), and filters the results to ones that are marked public (<code>is_visible = true</code>).</p>
<p>As you can see, ElasticSearch queries are a highly nested JSON structure. Having to manage all these nodes and keep them in order can be complex and error prone.</p>
<p>Contrast the same query using ElasticUtils:</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> elasticutils <span class="token keyword">import</span> S

query <span class="token operator">=</span> S<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>is_visible<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>query<span class="token punctuation">(</span>_all__query_string<span class="token operator">=</span><span class="token string">'nike air max'</span><span class="token punctuation">)</span>
</code></pre>
<p>Notice how we can construct the same nested structure, in a chainable fashion that allows us to augment or enhance our existing queries? What if we wanted to restrict our query just to products in our <code>shoes</code> category?</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python">query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>category<span class="token operator">=</span><span class="token string">"shoes"</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="django-integration">Django Integration</h2>
<p>While <a href="https://github.com/mozilla/elasticutils">ElasticUtils</a> is a general python library, it comes with some django integration out of the box to simplify integration. First, if you use the django-ized versions of the API constructs (<code>S</code>, <code>F</code>, etc), they will leverage the django settings system for configuration like ElasticSearch server URLs.</p>
<p>Second, ElasticUtils has pre-defined <a href="http://www.celeryproject.org">Celery</a> tasks for indexing and un-indexing your django models. This Makes it really straightforward to hook up a <code>post_save</code> signal handler to your models to have them re-indexed when updated in real-time (vs the traditional overnight batch re-index).</p>
<p>The one missing out-of-the-box component for Django is a management command for indexing your data. There’s an incomplete <a href="https://github.com/mozilla/elasticutils/pull/168">pull-request</a> that’s unfortunately been sidelined for now. Hopefully the team behind ElasticUtils can come together and finish it off. In the meantime, you can easily roll your own in less than 100 lines of code.</p>
<h2 id="indexing-your-data">Indexing your Data</h2>
<h3 id="assembling-your-mappings">Assembling your Mappings</h3>
<p>To define your indexes in <a href="https://github.com/mozilla/elasticutils">ElasticUtils</a>, you define a <code>MappingType</code> class much like in the Django ORM, you’d define a <code>Model</code>. This allows you to provide the necessary parameters to ElasticSearch to define the properties of the index and provide helper methods to perform the indexing and construct the searches.</p>
<p>The amount of boilerplate code required depends on whether you’re using the base <code>MappingType</code> or the django-ized version. The django version leverages the Django ORM for retrieval of documents to index as an example.</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python">
<span class="token keyword">from</span> elasticutils<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>django <span class="token keyword">import</span> Indexable<span class="token punctuation">,</span> MappingType
<span class="token keyword">from</span> example<span class="token punctuation">.</span>product<span class="token punctuation">.</span>models <span class="token keyword">import</span> Product


<span class="token keyword">class</span> <span class="token class-name">ProductMapping</span><span class="token punctuation">(</span>MappingType<span class="token punctuation">,</span> Indexable<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_index</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'products'</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_mapping_type_name</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"product"</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_model</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> Product

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_mapping</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token comment"># TBD</span>
        <span class="token punctuation">}</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">extract_document</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> obj_id<span class="token punctuation">,</span> obj<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token comment"># TBD</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>There’s a couple methods with TBDs (<code>extract_document()</code>, <code>get_mapping()</code>) in there that we’ll revisit individually, but you can see much of this is scaffolding not unlike the <code>Meta</code> class on Django models (but using classmethods rather than a nested inner class). These configuration methods for the most part just convert their output to JSON and are delivered to ElasticSearch un-modified.</p>
<h3 id="defining-your-data-mapping">Defining your Data Mapping</h3>
<p>The mapping configuration ultimately defines how ElasticSearch stores and indexes your data. It needs to know what fields are available in a given index, and parameters on how to consume and process those fields. If you’ve ever used <a href="http://lucene.apache.org/solr/">Apache SOLR</a>, you’ll be relieved how much easier this configuration is compared to the XML-hell that you’ve surely experienced.</p>
<p>For our example Product index, let’s create some common fields that might be associated with a product listing. This isn’t designed to be a full tutorial on elasticsearch, so we’ll have to skip over some of the more complex configuration options around analyzers, tokenizers and other indexing controls.</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token decorator annotation punctuation">@classmethod</span>
<span class="token keyword">def</span> <span class="token function">get_mapping</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">'properties'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
                <span class="token string">'analyzer'</span><span class="token punctuation">:</span> <span class="token string">'snowball'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">'sku'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
                <span class="token string">'index'</span><span class="token punctuation">:</span> <span class="token string">'not_analyzed'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">'price'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span>
                <span class="token string">'index'</span><span class="token punctuation">:</span> <span class="token string">'not_analyzed'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">'category'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
                <span class="token string">'index'</span><span class="token punctuation">:</span> <span class="token string">'not_analyzed'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>Most of our fields are designated as type <code>string</code>, while our <em>price</em> field is an integer (it will be number of cents, so <code>price_in_dollars * 100</code>). You’ll notice that many of the fields have an attribute <code>analyzer: not_analyzed</code>. This is an instruction to ElasticSearch not to attempt to parse the field and just leave it as is. Normally, ElasticSearch would split the field into terms based on word boundaries (see the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/analysis-standard-analyzer.html">standard analyzer</a> which is the default). But for many of the fields, we want to it to be indexed and stored exactly as we delivered (such as for <em>sku</em> which should be treated as a single term). For <em>description</em>, we’ve used the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/analysis-snowball-analyzer.html">snowball analyzer</a> which provides additional filtering around stop words and stemming. You can also create your own analyzers for more custom indexing of a given field.</p>
<p>This is just the tip of the iceberg. There’s a multitude of configuration parameters for each field in your mapping.</p>
<h3 id="extracting-fields-during-indexing">Extracting Fields during Indexing</h3>
<p>After defining the index mapping fields, let’s implement the other un-implemented method, <code>extract_document()</code>, that captures and prepares your data into the relevant fields. This provides you the control in extracting and transforming your data prior to ingestion by elasticsearch.</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python">
    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">extract_document</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> obj_id<span class="token punctuation">,</span> obj<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> obj <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            obj <span class="token operator">=</span> cls<span class="token punctuation">.</span>get_model<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span>obj_id<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token string">'id'</span><span class="token punctuation">:</span> obj<span class="token punctuation">.</span>pk<span class="token punctuation">,</span>
            <span class="token string">'name'</span><span class="token punctuation">:</span> obj<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            <span class="token string">'description'</span><span class="token punctuation">:</span> obj<span class="token punctuation">.</span>description<span class="token punctuation">,</span>
            <span class="token string">'sku'</span><span class="token punctuation">:</span> obj<span class="token punctuation">.</span>sku<span class="token punctuation">,</span>
            <span class="token string">'price'</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>price <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Convert to cents</span>
            <span class="token string">'category'</span><span class="token punctuation">:</span> obj<span class="token punctuation">.</span>category<span class="token punctuation">.</span>name<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment"># assuming `category` is a foreign key</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>Here we’ve extracted several attributes on our model as well the product category from a related model.</p>
<h3 id="create-indexes">Create Indexes</h3>
<p>Finally, With all your mappings configured, you can now create or update your indexes using elasticsearch. We simply generate a settings configuration based on the elasticsearch options and elasticutils does the work for us.</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python">
es <span class="token operator">=</span> ProductMapping<span class="token punctuation">.</span>get_es<span class="token punctuation">(</span><span class="token punctuation">)</span>
settings <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># Add our mapping configuration to the index settings</span>
settings<span class="token punctuation">.</span>update<span class="token punctuation">(</span>ProductMapping<span class="token punctuation">.</span>get_mapping<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># TBD: Add index settings here such as custom analyzers</span>

es<span class="token punctuation">.</span>create_index<span class="token punctuation">(</span>ProductMapping<span class="token punctuation">.</span>get_index<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> settings<span class="token operator">=</span>settings<span class="token punctuation">)</span>
</code></pre>
<p>Finally, let’s leverage the built-in celery tasks to perform the index on our model data. To index a model, you simply provide its primary key to the <code>index_objects</code> task, which as we’ve defined above in <code>extract_document()</code>, will pull it from the database and extract the fields for indexing.</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> elasticutils<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>django <span class="token keyword">import</span> tasks


model_objs <span class="token operator">=</span> ProductMapping<span class="token punctuation">.</span>get_model<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
model_ids <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>model_objs<span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">'pk'</span><span class="token punctuation">,</span> flat<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
tasks<span class="token punctuation">.</span>index_objects<span class="token punctuation">(</span>ProductMapping<span class="token punctuation">,</span> model_ids<span class="token punctuation">)</span>
</code></pre>
<h2 id="searching-your-index">Searching your Index</h2>
<p>Now that we’ve indexed our data, let’s walk through a couple example searches that can demonstration the richness of the ElasticSearch and ElasticUtils query expression API.</p>
<p>Couple of notes on the ElasticUtils <code>S</code> class that handles your search queries. They mimic many of the attributes of Django’s querysets.</p>
<ul>
<li>They’re chainable, so you can build up your search parameters through successive calls to add filters, queries and other parameters. Likewise, you can build-up common base search parameters and re-use it for a number of sub-queries that share those common parameters.</li>
<li>They’re lazy, so search is only performed when you try to act on the data such as iterating, or calling specific methods like <code>count()</code>.</li>
</ul>
<h3 id="search-for-matching-terms">Search for Matching Terms</h3>
<p>Let’s start with the obvious use case, we want to find all products who’s name contains the key search terms. With <a href="http://lucene.apache.org">Lucene</a> based indexes, you usually can choose between a rich user supplied query language like a google search or constructing your search parameters more programatically (or a combination of both). If you’re looking to give your users a free-form input (again, like Google) to specify their search parameters with operators and other modifiers (for example: <code>nike AND "air max" or category:shoes</code>), you’re like going to want to use ElasticSearch’s <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html">query string query</a>. On the other hand, if your interface is more data oriented (say a bunch of checkboxes and sliders for controlling the search parameters), you’ll want more exact search controls, you’ll want to leverage ElasticSearch’s <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-queries.html">many other queries</a> including <code>match</code>, <code>range</code> and <code>bool</code> queries.</p>
<p>ElasticUtils takes a cue from django’s querysets and allows you to specify the type of query using a double underscore qualifier. So you can search a given field using a type of query like: <code>[field_name]__[query_type]</code>.</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python">s <span class="token operator">=</span> ProductMapping<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">)</span>
results <span class="token operator">=</span> s<span class="token punctuation">.</span>query<span class="token punctuation">(</span>name__query_string<span class="token operator">=</span><span class="token string">'nike "air max" or category:shoes'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
    <span class="token comment"># process the results</span>
</code></pre>
<p>If instead of a free-form query string, we could instead build up a search programmatically using another query type. ElasticSearch provides a <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-prefix-query.html">prefix query</a> that can provide a good way to autocomplete search terms that begin with the inputted search phrase. They’re are more efficient methods using ngrams, but this will suffice for our example.</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python">s <span class="token operator">=</span> ProductMapping<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Returns all results that start with 'nik' in the `shoes` category</span>
results <span class="token operator">=</span> s<span class="token punctuation">.</span>query<span class="token punctuation">(</span>name__prefix<span class="token operator">=</span><span class="token string">'nik'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>category<span class="token operator">=</span><span class="token string">'shoes'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
    <span class="token comment"># process the results</span>
</code></pre>
<h3 id="faceted-search-results">Faceted Search Results</h3>
<p>One of the powerful features of ElasticSearch is the ability to quickly generate facets based on your indexed fields. If you’re unfamiliar with facets, think of a tag cloud, or a list of categories (such as brands on an e-commerce site) that allow you to drill-down through a list of results to find your intended document.</p>
<p>In our example mapping, we have a <em>category</em> field that would be a nice facet to help our users select which category they’re looking for within our search results. Let’s first search for “nike” and then display a list of categories that have matches for that product name.</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python">s <span class="token operator">=</span> ProductMapping<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Add facet results for `category`</span>
query <span class="token operator">=</span> s<span class="token punctuation">.</span>query<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'nike'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>facet<span class="token punctuation">(</span><span class="token string">'category'</span><span class="token punctuation">)</span>
facets <span class="token operator">=</span> query<span class="token punctuation">.</span>facet_counts<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Let's iterate the category facets</span>
<span class="token keyword">for</span> facet <span class="token keyword">in</span> facets<span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    category <span class="token operator">=</span> facet<span class="token punctuation">[</span><span class="token string">'term'</span><span class="token punctuation">]</span>
    count <span class="token operator">=</span> facet<span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span>
</code></pre>
<h3 id="counts">Counts</h3>
<p>Sometimes, you don’t necessarily need to retrieve the search results, but just want to display the number of results. Like the Django ORM, you can call <code>.count()</code> to retrieve the number of results for a given query.</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python">s <span class="token operator">=</span> ProductMapping<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Returns all results that start with 'nik' in the `shoes` category</span>
num_results <span class="token operator">=</span> s<span class="token punctuation">.</span>query<span class="token punctuation">(</span>name__prefix<span class="token operator">=</span><span class="token string">'nik'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>category<span class="token operator">=</span><span class="token string">'shoes'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Again, this is just a sampler. There are numerous ways to search in elasticsearch and these are but a few simple examples. As your queries grow in complexity, the chain-ability of ElasticUtils search API keeps everything manageable.</p>
<h2 id="conclusion">Conclusion</h2>
<p>There you have it, a method to build complex search systems using the powerful <a href="http://www.elasticsearch.org">ElasticSearch</a> systsem in a very pythonic manner. If you’re familiar with the common Django ORM patterns, it’s even better.</p>
<p>Hopefully this gives you an overview of the <a href="https://github.com/mozilla/elasticutils">ElasticUtils</a> python library as a powerful interface to the ElasticSearch indexing and retrieval system. Much like the Django ORM makes working with databases easier compared with raw SQL, ElasticUtils makes performing complex search queries easier than building your own ElasticSearch ReST calls.</p>
<p>This was really just an introduction, we only showed simple field extraction and text searching. Much of the power of elasticsearch is realized when you start implementing more complex patterns like faceting, range queries, autocomplete, spell correction and suggestions. If there’s interest (leave me a comment), I’ll work on follow-up posts on how to construct those patterns on top of ElasticUtils.</p>
<h3 id="caveats">Caveats</h3>
<p>I wrote this guide based on ElasticUtils v0.80. The development trunk recently ported from the underlying <a href="https://github.com/rhec/pyelasticsearch">pyelasticsearch</a> library, to the officially blessed, <a href="https://github.com/elasticsearch/elasticsearch-py">elasticsearch-py</a> python bindings. While ElasticUtils for the most part masks the need to understand the underlying library, esoteric or management commands may require direct library access.</p> <section><script>(()=>{var a=(s,i,o)=>{let r=async()=>{await(await s())()},t=typeof i.value=="object"?i.value:void 0,c={rootMargin:t==null?void 0:t.rootMargin},n=new IntersectionObserver(e=>{for(let l of e)if(l.isIntersecting){n.disconnect(),r();break}},c);for(let e of o.children)n.observe(e)};(self.Astro||(self.Astro={})).visible=a;window.dispatchEvent(new Event("astro:visible"));})();</script><astro-island uid="1RSTln" prefix="r3" component-url="/assets/Disqus.BzGoIwSE.js" component-export="default" renderer-url="/assets/client.C7vZbhPY.js" props="{&quot;id&quot;:[0,&quot;elasticutils&quot;],&quot;title&quot;:[0,&quot;ElasticSearch Bliss with ElasticUtils&quot;],&quot;shortname&quot;:[0,&quot;kevinstone&quot;]}" ssr client="visible" opts="{&quot;name&quot;:&quot;Disqus&quot;,&quot;value&quot;:true}" await-children><div id="disqus_thread"></div><!--astro:end--></astro-island></section> </article>   </div> </main> <footer data-astro-cid-sz7xmlte> <div class="fixed-width">  <p data-astro-cid-sz7xmlte>&copy; Kevin A. Stone 2026, Built with <a href="https://astro.build/" data-astro-cid-sz7xmlte>Astro</a></p>  </div> </footer>  </body></html>