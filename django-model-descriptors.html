<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Django Model Descriptors</title>
    <meta name="description" content="">
    <meta name="author" content="Kevin Stone">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="./theme/html5.js"></script>
    <![endif]-->

    <link href="https://blog.kevinastone.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Kevin Stone Full Atom Feed" />
    <link href="https://blog.kevinastone.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Kevin Stone Full RSS Feed" />
    <link href="https://blog.kevinastone.com/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Kevin Stone Categories Atom Feed" />
    <link href="https://blog.kevinastone.com/feeds/{slug}.rss.xml" type="application/rss+xml" rel="alternate" title="Kevin Stone Categories RSS Feed" />


    <!-- Le styles -->

    <link href="./theme/dist/css/main.d647f715f58900baa686.css" rel="stylesheet">
    <link href="./theme/pygments.css" rel="stylesheet">

</head>

<body >

<header class="navigation navigation--float" role="banner">
  <div class="navigation-wrapper">
    <div class="logo">
        <a href="." class="logo">Kevin Stone</a>
    </div>
    <div class="nav-right">
      <div class="search-bar">
          <div id="search-form" class="js-d-search-form" data-index-url="https://blog.kevinastone.com/feeds/index.all.atom.xml.json"></div>
      </div>
      <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">MENU</a>
      <nav class="navigation-tools" role="navigation">
        <ul id="js-navigation-menu" class="navigation-menu show">
          <li class="nav-link"><a href="./archives.html">Archives</a></li>
          <li class="nav-link more"><a href="./tags.html">Tags</a>
              <ul class="submenu">
                  <li><a href="./tag/angularjs.html">AngularJS</a></li>
                  <li><a href="./tag/django.html">Django</a></li>
                  <li><a href="./tag/elasticsearch.html">ElasticSearch</a></li>
                  <li><a href="./tag/python.html">Python</a></li>
                  <li><a href="./tag/rest.html">ReST</a></li>
                  <li><a href="./tag/subblime.html">Subblime</a></li>
              </ul>
          </li>
          <li class="nav-link more"><a href="./links.html">Links</a>
                <ul class="submenu">
                    <li><a href="http://github.com/kevinastone">GitHub</a></li>
                    <li><a href="https://twitter.com/kevinastone">Twitter</a></li>
                    <li><a href="http://www.linkedin.com/in/kevinastone">LinkedIn</a></li>
                    <li><a href="http://stackoverflow.com/users/2089197/kevin-stone">Stack Overflow</a></li>
                    <li><a href="http://slid.es/kevinastone">Slid.es</a></li>
                </ul>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

<div class="hero trianglify-background" style="background-image: url('/images/backgrounds/gradient-patterns-simple-background-widescreen-798987-1920x1080.jpg'), filter(url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDACAWGBwYFCAcGhwkIiAmMFA0MCwsMGJGSjpQdGZ6eHJmcG6AkLicgIiuim5woNqirr7EztDOfJri8uDI8LjKzsb/2wBDASIkJDAqMF40NF7GhHCExsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsb/wAARCAAXACoDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAQFAwL/xAAeEAACAQQDAQAAAAAAAAAAAAAAAwIBESExBBJhE//EABYBAQEBAAAAAAAAAAAAAAAAAAMCBP/EABsRAAMAAwEBAAAAAAAAAAAAAAABAhEhMRJB/9oADAMBAAIRAxEAPwCPCFzeKjtS7jqkXM9UbZhJbEvj4cyV4VfhjRmxGNE+mViWSJrsZ9R9yrC/TwRUHUD3HjooqhSwAEul3wYorBkyAAI1oGW8k/kQEq0yABo0fD//2Q=='), blur(20px));" data-seed="django-model-descriptors">
    <div class="hero-inner">
        <div class="hero-copy">
            <h1>Django Model Descriptors</h1>
<div class="text-right">
by <a class="url fn" href="./author/kevin-stone.html">Kevin Stone</a>
<br>
 
November 26, 2014
</div>        </div>
    </div>
</div>

<div class="container">
    <div class="content"><article class="article">
    <div><p>How can we enhance our Django model fields to act beyond simple database types
to encapsulate their associated business logic?  Leveraging Python's
descriptor protocol, we provide additional processing on retrieval and update
to allow more re-usable fields.</p>

<h1 id="python-descriptors">Python Descriptors</h1>
<p>What are <a href="https://docs.python.org/2/howto/descriptor.html">Python Descriptors</a>?  They're one of the least
understood aspects of the language, but I think of them like class-based
<a href="https://docs.python.org/2/library/functions.html#property">properties</a>.  Just as you can provide a <code>__call__</code> method on a
class so that it acts like a function, you can supply a <code>__get__</code> (or
<code>__set__</code> or <code>__delete__</code>) and the class will similarly act more like a
property.</p>
<p>This allows us to capture common property definitions in a re-usable construct
that we can apply as generic functionality to our models.  If you're read the
post on <a href="./django-model-behaviors.md">Django Model Behaviors</a>, you understand how
to package common field definitions into a shared model behavior that you can
combine to assemble your models from more atomic functionality.  Leveraging
descriptors, you can perform a similar deconstruction but this time by
creating re-usable fields with enhanced logic without being tied to a given
model definition.</p>
<h3 id="sample-code">Sample Code</h3>
<p>All the sample code for this project is available on a <a href="https://github.com/kevinastone/django-descriptors">GitHub
repository</a>. Feel free to use it as the basis for your own
experimentation.</p>
<h1 id="enhance-your-models-with-properties">Enhance your Models with Properties</h1>
<p>A common use of properties is to perform calculations or manipulations on a
given field and provide that as additional information.</p>
<p>For example, let's start with this Bookmark model that features a <code>url</code> field:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Bookmark</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">()</span>
</pre></div>
<p>It's very simple and straightforward.  Now let's say we want to extract some
additional information about the stored url, say it's domain/hostname so we
can show a favicon on our listing.  Since the url already contains the
hostname, we can add a method or a property to our model which retrieves the
url, and then parses out the hostname.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Bookmark</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hostname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">hostname</span>
</pre></div>
<p>Now, when we're accessing our bookmark model instances, we can simple refer to
<code>obj.hostname</code>.  This pattern works great for many common derived or computed
values.  No reason to store redundant information when we can calculate it on
the fly from other model attributes.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">boomark</span> <span class="o">=</span> <span class="n">Bookmark</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">'http://example.com/abcd'</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># Let's access our hostname property</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bookmark</span><span class="o">.</span><span class="n">hostname</span>
<span class="s1">'example.com`</span>
</pre></div>
<p>But as we add more and more computed values, these properties tend to overload
our models, cluttering our codebase.  Plus, we are frequently adding the same
properties again and again, repeating the same functionality for each field.
What we'd like is a way to associate a given property with the model field
that derives it.</p>
<h1 id="descriptors-as-reusable-properties">Descriptors as Reusable Properties</h1>
<p>Rather than define a bunch of properties, what we'd rather do is something
like: <code>obj.url.hostname</code>, and encapsulate all the derived logic on the url
field.  Yet when you access a model instance's field, it's simply returned
just like the original python type (str/unicode in the case of a <em>URLField</em>).
These additional properties would be transparent to the rest of the code.</p>
<p>So, we need to intercept the value returned by accessing the field on the
instance and <strong>enhance</strong> it with our custom properties.  This is where the
descriptor protocol comes into play.  It gives us a chance to intercept and
substitute the value returned when an attribute is accessed on a given class
instance.</p>
<p>To make this work, we actually need two components.  First, we need our
descriptor which performs the intercept and substitution.  Second, we need a
proxy model that acts like the original datatype, but is augmented with the
additional custom properties.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">URLFieldProxy</span><span class="p">(</span><span class="nb">unicode</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hostname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">hostname</span>


<span class="k">class</span> <span class="nc">ProxyFieldDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">proxy_class</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span> <span class="o">=</span> <span class="n">field_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_class</span> <span class="o">=</span> <span class="n">proxy_class</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># grab the original value before we proxy</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># We can't proxy a None through a unicode sub-class</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_class</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</pre></div>
<p>Our <em>Proxy</em> class, <code>URLFieldProxy</code>, sub-classes the base type that the field
would return (<code>unicode</code> in this case).  That ensures we have the same base
datatype.  And then it adds a property for calculating the derived value(s).</p>
<p>Our <em>Descriptor</em> class, <code>ProxyFieldDescriptor</code>, is a regular python object,
with the magic methods <code>__get__</code> and <code>__set__</code> that define a descriptor.  It
features a constructor that takes a two arguments, the name of the field we
want to intercept, and the proxy class we want to substitute.  The <code>__get__</code>
implementation looks up the original value of the intercepted field using
<code>instance.__dict__</code> and then instantiates our proxy class passing in that
original value.  We special case <code>None</code> since our proxy can't handle that type
directly (<em>None</em> values can't have properties). <code>__set__</code> simply stores the
value directly without modification.</p>
<p>Before we talk through how to attach this descriptor to your django model
field, let's put our implementation through some paces to show how a
descriptor operates.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SomeObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Let's add our descriptor on the `url` field substituting `URLFieldProxy`</span>
    <span class="n">wormhole</span> <span class="o">=</span> <span class="n">ProxyFieldDescriptor</span><span class="p">(</span><span class="s1">'url'</span><span class="p">,</span> <span class="n">URLFieldProxy</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
</pre></div>
<p>Remember that we defined our descriptor to look up it's real value from the
passed in argument name.  It then returns the <em>Proxy</em> model that adds the
computed properties.  Let's see it in action:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">SomeObject</span><span class="p">(</span><span class="s1">'http://example.com/asdf'</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># Normal attribute access still works</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">url</span>
<span class="s1">'http://example.com/asdf'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># Does obj.url have a hostname property?</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">hostname</span>
<span class="o">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span>                            <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># What about accessing our descriptor field?</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">wormhole</span>
<span class="sa">u</span><span class="s1">'http://example.com/asdf'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># Let's access the descriptor's property</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">wormhole</span><span class="o">.</span><span class="n">hostname</span>
<span class="sa">u</span><span class="s1">'example.com'</span>

<span class="c1"># As you can see, the descriptor returns our proxy</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">wormhole</span><span class="p">)</span>
<span class="n">__main__</span><span class="o">.</span><span class="n">URLFieldProxy</span>

<span class="c1"># But the proxy still *acts* like our original url attribute</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">wormhole</span> <span class="o">==</span> <span class="n">obj</span><span class="o">.</span><span class="n">url</span>
<span class="bp">True</span>
</pre></div>
<h2 id="customize-django-model-fields-with-descriptors">Customize Django Model Fields with Descriptors</h2>
<p>Now, we need to customize the Django <code>URLField</code> to hook in to the descriptor
class. Thankfully, django provides an accessible mechanism under a method
named <code>contribute_to_class</code> that allows you to customize how a field class is
attached to its model instance.  The specifics of how this method works are
convoluted and related to the metaclass magic that django model definitions
perform.</p>
<p>Since <code>contribute_to_class</code> is used by django when building the model
instance, we simply attach our descriptor in the place of the field's name on
our constructed model instance using <code>setattr()</code> with <code>self.name</code> representing
the name of the field ("url" in our case).</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HostnamedURLField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">contribute_to_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HostnamedURLField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">contribute_to_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># Add our descriptor to this field in place of of the normal attribute</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ProxyFieldDescriptor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">URLFieldProxy</span><span class="p">))</span>
</pre></div>
<p>Finally, let's update our model to use our customized url field.  Notice our
model definition knows nothing about hostnames, it's all encapsulated in our
customized <em>URLField</em>.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Bookmark</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">HostnamedURLField</span><span class="p">()</span>
</pre></div>
<p>With the model all wired up with our descriptor wielding field, let's
see if it works.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">bookmark</span> <span class="o">=</span> <span class="n">Bookmark</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">'http://example.com/asdf'</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">bookmark</span><span class="o">.</span><span class="n">url</span>
<span class="sa">u</span><span class="s1">'http://example.com/asdf'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">bookmark</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">hostname</span>
<span class="sa">u</span><span class="s1">'example.com'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># You can assign to the descriptor field too</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bookmark</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">'http://somewhere.com/else'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># And it still keeps all the same semantics</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bookmark</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">hostname</span>
<span class="sa">u</span><span class="s1">'somewhere.com'</span>
</pre></div>
<p>There you go, we have a successfully migrated a computed property from the
model definition to the field definition.  This helps keep common
functionality encapsulated, allowing greater re-use and cleaner separation of
concerns.</p>
<h1 id="descriptors-for-alternative-representations">Descriptors for Alternative Representations</h1>
<p>Besides just augmenting fields with computed properties, descriptors can also
be used to provide additional representations for your model data.</p>
<p>One of my favorite database modeling patterns is to use timestamps for boolean
flags.  If a timestamp is NULL, it's off (or disabled).  When a timestamp is
set, the flag is enabled.  This gives you both a status (on/off) as well as a
history of when the flag was enabled.</p>
<p>In most uses, we're only concerned with the status, so a boolean data type is
more representative.  But certain views would like to know this date
information (for say a management overview).</p>
<p>Let's create another simple model to walk through such a use case:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">BlogPost</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">published_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
<p>With a <code>published_at</code> field, we can show visitors posts that have been marked
ready for publication, as well as sort our blog posts based on their
publication date.  This same pattern works great for any moderation task,
including comments, account setup, or content release.</p>
<p>With our model, we can create a few posts and then publish them by setting our
timestamp field to a non-NULL value.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">published_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">published_at__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># Now let's set our published flag</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">published_at</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">published_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">published_at__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">BlogPost</span><span class="p">:</span> <span class="n">BlogPost</span> <span class="nb">object</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
<h2 id="creating-a-hybrid-booleantimestamp-descriptor">Creating a Hybrid Boolean/Timestamp Descriptor</h2>
<p>Using a datetime field gives us that extra information, but it makes working
with such fields less intuitive.  You have to know it's a datetime value
rather than a boolean.  What if we could use descriptors to modify the
returned field to act like a boolean?</p>
<p>Let's create a descriptor class that proxies our datetime value, but acts like
a boolean.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TimestampedBooleanDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
<p>It handles two cases, the first is on <code>__get__</code> where it checks its stored
timestamp against None.  The other case is when <code>__set__</code> is called, it checks
the input value (a boolean) and if it's changed, either sets or clears the
internal datetime representation.</p>
<p>Let's build an example to use this descriptor.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SomeObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Let's add our descriptor on the `timestamp` field</span>
    <span class="n">boolean</span> <span class="o">=</span> <span class="n">TimestampedBooleanDescriptor</span><span class="p">(</span><span class="s1">'timestamp'</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
</pre></div>
<p>And let's put our sample object through some paces:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">SomeObject</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">timestamp</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">boolean</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">boolean</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">boolean</span> <span class="o">=</span> <span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">timestamp</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">boolean</span> <span class="o">=</span> <span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">timestamp</span>
<span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">872457</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=&lt;</span><span class="n">UTC</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
<p>Through the descriptor protocol, we were able to extend the functionality of
our fields to both support a datetime and a boolean interface.</p>
<p>Now, let's extend the built-in <code>DateTimeField</code> to use our descriptor class to
provide both interfaces.  Our field adds two capabilities: first, we want to
add a second property on the given model for the boolean access (it defaults
to <code>is_&lt;field_name&gt;</code>).  Second, we again use <code>contribute_to_class</code> to add our
additional boolean property on the model class.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TimestampedBooleanField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    A Boolean field that also captures the timestamp when the value was set.</span>

<span class="sd">    This field stores a timestamp in the database when set.  It can be accessed</span>
<span class="sd">    as a boolean using the property argument (when not provided, it defaults to</span>
<span class="sd">    is_{field_name}).</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">property_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'property'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">'null'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TimestampedBooleanField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">contribute_to_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TimestampedBooleanField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">contribute_to_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># Use the defined boolean property name or pick a default</span>
        <span class="n">property_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">property_name</span> <span class="ow">or</span> <span class="s1">'is_{0}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">property_name</span><span class="p">,</span> <span class="n">TimestampedBooleanDescriptor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</pre></div>
<p>Let's now update our <code>BlogPost</code> model to use this timestamp field.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BlogPost</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">published_at</span> <span class="o">=</span> <span class="n">TimestampedBooleanField</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">'is_published'</span><span class="p">)</span>
</pre></div>
<p>With the model all wired up with our descriptor wielding field, let's
see if it works.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">published_at</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="bp">True</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">is_published</span>
<span class="bp">False</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">is_published</span> <span class="o">=</span> <span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">published_at</span>
<span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">191879</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=&lt;</span><span class="n">UTC</span><span class="o">&gt;</span><span class="p">)</span>

<span class="c1"># Still works after reloading from the DB</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post2</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">post</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post2</span><span class="o">.</span><span class="n">is_published</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post2</span><span class="o">.</span><span class="n">published_at</span>
<span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">191879</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=&lt;</span><span class="n">UTC</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
<p>There you go, depending on how you want to access your model, you can choose
to use either the timestamp attribute or the boolean.  All of this is
encapsulated in a descriptor class, keeping your model definition clean and
intuitive.</p>
<h1 id="summary">Summary</h1>
<p>There's numerous opportunities to leverage descriptors to enhance your model
fields. Django itself uses them to handle File Upload fields since they're
stored in the database as pathnames to the file, but provided as a file-like
proxies to your django code.</p>
<p>There's plenty of additional uses for descriptors.  Please leave a comment (or
tweet, etc) if you have addditional ideas or examples where descriptors can
improve your model code.</p></div>

    <hr>
       
    <h2>Comments</h2>
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="kevinastone">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'kevinstone';
    var disqus_identifier = 'django-model-descriptors';
    var disqus_title = 'Django Model Descriptors';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</article>

</div>
</div>


<footer class="footer" role="contentinfo">
    <div class="footer-links">
        <ul>
            <li><h3>Content</h3></li>
            <li><a href="./archives.html">Archives</a></li>
        </ul>
        <ul>
            <li><h3>Tags</h3></li>
            <li><a href="./tag/angularjs.html">AngularJS</a></li>
            <li><a href="./tag/django.html">Django</a></li>
            <li><a href="./tag/elasticsearch.html">ElasticSearch</a></li>
            <li><a href="./tag/python.html">Python</a></li>
            <li><a href="./tag/rest.html">ReST</a></li>
            <li><a href="./tag/subblime.html">Subblime</a></li>
        </ul>
        <ul>
            <li><h3>Links</h3></li>
            <li><a href="http://github.com/kevinastone">GitHub</a></li>
            <li><a href="https://twitter.com/kevinastone">Twitter</a></li>
            <li><a href="http://www.linkedin.com/in/kevinastone">LinkedIn</a></li>
            <li><a href="http://stackoverflow.com/users/2089197/kevin-stone">Stack Overflow</a></li>
            <li><a href="http://slid.es/kevinastone">Slid.es</a></li>
        </ul>
    </div>

    <hr>

    <p>&copy; Kevin Stone 2013-2019</p>
</footer>



<script src="./theme/dist/js/runtime.8db8c9afbf4f91bacfee.js" defer async></script>
<script src="./theme/dist/js/vendors~search.92c2fcc9438374ad808f.js" defer async></script>
<script src="./theme/dist/js/search.1f82199c9b87bdbbc671.js" defer async></script>
<script src="./theme/dist/js/vendors~refills.e6a2772013145367b32b.js" defer async></script>
<script src="./theme/dist/js/refills.612949b632008505a5e9.js" defer async></script>
<script src="./theme/dist/js/vendors~trianglify.8c5bb6f6ad77a3cd4e64.js" defer async></script>
<script src="./theme/dist/js/trianglify.b06c0f32ff3274042100.js" defer async></script>

<script>var _gaq=[['_setAccount','UA-44610401-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>
</body>
</html>